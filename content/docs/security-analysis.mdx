---
title: An√°lisis de Seguridad
description: An√°lisis exhaustivo de seguridad de VW Activities Platform
---

# An√°lisis de Seguridad - VW Activities Platform

## Resumen Ejecutivo

Este documento presenta un an√°lisis exhaustivo de las medidas de seguridad implementadas en la plataforma VW Activities. El sistema cuenta con m√∫ltiples capas de protecci√≥n contra amenazas comunes, incluyendo autenticaci√≥n robusta, rate limiting, anti-bot, validaci√≥n de datos, y auditor√≠a completa.

**Estado General**: ‚úÖ La plataforma cuenta con medidas de seguridad defensivas s√≥lidas

---

## 1. Autenticaci√≥n y Autorizaci√≥n

### 1.1 Sistema de Autenticaci√≥n (NextAuth.js)

**Archivo**: [src/lib/auth.ts](../src/lib/auth.ts)

#### Caracter√≠sticas Implementadas:

‚úÖ **Multi-Provider Authentication**
- Credenciales (email/password)
- OAuth 2.0 con Google
- Extensible para m√°s providers

‚úÖ **Protecci√≥n de Contrase√±as**
- Hashing con bcrypt (algoritmo bcryptjs)
- Contrase√±as nunca almacenadas en texto plano
- Comparaci√≥n segura con timing-attack protection

‚úÖ **Sesiones JWT**
```typescript
session: {
  strategy: 'jwt',
  maxAge: 30 * 24 * 60 * 60, // 30 d√≠as
}
```
- Tokens firmados con NEXTAUTH_SECRET
- No requieren almacenamiento server-side
- Auto-expiraci√≥n configurada

‚úÖ **Verificaci√≥n de Email Obligatoria**
```typescript
if (!user.emailVerified) {
  throw new Error('EMAIL_NOT_VERIFIED:Debes verificar tu email...');
}
```
- Previene cuentas fraudulentas
- Flujo de verificaci√≥n por email
- Tokens de verificaci√≥n √∫nicos con expiraci√≥n

‚úÖ **Integraci√≥n CAPTCHA en Login**
```typescript
const captchaResult = await verifyCaptcha(
  credentials.captchaToken,
  credentials.clientIp
);
```
- Protecci√≥n contra bots en login
- Validaci√≥n con hCaptcha
- Registro de intentos fallidos

#### Sistema de Roles (RBAC)

**Roles Implementados**:
- `SUPER_ADMIN` - Administrador global
- `COMPANY_ADMIN` - Administrador por empresa
- `CAMPAIGN_CREATOR` - Creador de campa√±as
- `END_USER` - Usuario final

**Archivo Middleware**: [src/middleware.ts](../src/middleware.ts)

```typescript
const token = await getToken({ req: request });
if (!token) {
  // Redirect a login
}
```

### 1.2 Protecci√≥n de Rutas

**Rutas P√∫blicas Definidas**:
```typescript
const publicPaths = [
  '/auth/signin',
  '/auth/signup',
  '/auth/forgot-password',
  '/privacy',
  '/terms',
  // ...
];
```

**Verificaci√≥n Autom√°tica**:
- Middleware intercepta todas las rutas protegidas
- Redirecci√≥n autom√°tica a login si no autenticado
- Preservaci√≥n de callback URL para UX

---

## 2. Protecci√≥n Anti-Bot

### 2.1 Sistema hCaptcha

**Archivo**: [src/lib/captcha.ts](../src/lib/captcha.ts)

#### Implementaci√≥n:

‚úÖ **Verificaci√≥n Server-Side**
```typescript
export async function verifyCaptcha(
  token: string,
  remoteip?: string
): Promise<{ success: boolean; score?: number; errorCodes?: string[] }>
```

**Caracter√≠sticas**:
- Validaci√≥n con hCaptcha API oficial
- Registro de IP del cliente (opcional)
- Score de riesgo para actividades maliciosas
- Manejo de errores detallado
- Bypass configurable en desarrollo (`DISABLE_CAPTCHA=true`)

‚úÖ **Puntuaci√≥n de Riesgo Adaptativa**
```typescript
export function shouldShowCaptcha(riskScore: number): boolean {
  return riskScore >= 30 || process.env.NODE_ENV === 'production';
}
```

**Casos de Uso**:
- Registro de nuevos usuarios
- Login con alta sospecha
- Endpoints sensibles (gems, transfers)

### 2.2 Tracking de IP y Detecci√≥n de Patrones

**Campos en User Model**:
```prisma
registrationIp       String?   // IP del registro
registrationUserAgent String?  // User agent del registro
riskScore            Int? @default(0) // Puntuaci√≥n 0-100
verificationSpeed    Int? // Segundos entre registro y verificaci√≥n
suspensionReason     String? // Raz√≥n de suspensi√≥n
suspendedAt          DateTime? // Fecha de suspensi√≥n
```

**√çndices para Performance**:
```prisma
@@index([registrationIp])    // Buscar por IP
@@index([riskScore])         // Ordenar por riesgo
@@index([suspensionReason])  // Filtrar suspendidos
```

### 2.3 Sistema Anti-Multicuentas (Wallets)

**Modelo**: `UserWallet`

**Campos Cr√≠ticos**:
```prisma
model UserWallet {
  walletAddress     String
  network           String
  transactionCount  Int @default(1)
  riskFlags         Json? // Flags de riesgo detectados

  @@unique([userId, walletAddress, network])
  @@index([walletAddress]) // CR√çTICO
  @@index([walletAddress, network]) // CR√çTICO
}
```

**Detecci√≥n**:
- Una wallet usada por m√∫ltiples usuarios ‚Üí Flag de riesgo
- Tracking de volumen y frecuencia de transacciones
- Metadata de primera/√∫ltima transacci√≥n

---

## 3. Rate Limiting

### 3.1 Implementaci√≥n con Redis

**Archivo**: [src/lib/rate-limit.ts](../src/lib/rate-limit.ts)

#### Estrategia:

‚úÖ **Rate Limiting Distribuido**
- Usa Redis para sincronizaci√≥n entre workers PM2
- Migrado desde in-memory store (no funcional en multi-worker)
- Ventana deslizante (sliding window)

**Funci√≥n Principal**:
```typescript
export async function rateLimit(
  request: NextRequest,
  options: {
    windowMs: number;
    maxRequests: number;
    identifier?: string
  },
  userId?: string
): Promise<{
  success: boolean;
  remaining: number;
  resetTime: number;
  error?: string
}>
```

**Identificaci√≥n**:
```typescript
const ip = request.headers.get('x-forwarded-for') ||
           request.headers.get('x-real-ip') ||
           'unknown';
const key = identifier || `${ip}:${userId || 'anonymous'}`;
```

### 3.2 Configuraciones por Endpoint

**Presets Definidos**:
```typescript
RATE_LIMIT_CONFIGS = {
  GEMS_BALANCE: { windowMs: 60000, maxRequests: 60 },
  GEMS_AWARD: { windowMs: 60000, maxRequests: 10 },
  GEMS_SPEND: { windowMs: 60000, maxRequests: 20 },
  GEMS_TRANSACTIONS: { windowMs: 60000, maxRequests: 30 }
}
```

**Endpoints Protegidos**:
- ‚úÖ Operaciones con gemas (balance, award, spend, transactions)
- ‚úÖ Autenticaci√≥n (register, login, verify-email)
- ‚úÖ Operaciones de exchange/crypto
- ‚úÖ APIs cr√≠ticas (campaigns, activities, submissions)

### 3.3 Limitaci√≥n Conocida

‚ö†Ô∏è **Edge Runtime Issue**:
```typescript
// middleware.ts l√≠nea 75-76
// SEGURIDAD: Rate limiting DESHABILITADO (Redis no funciona en Edge Runtime)
// TODO: Mover rate limiting a cada API route individualmente
```

**Estado Actual**:
- Rate limiting NO activo en middleware global
- Implementado individualmente en rutas cr√≠ticas
- Redis funcional en API routes (Node.js runtime)

**Recomendaci√≥n**:
‚úÖ Migrar todo rate limiting a nivel de API route (ya en progreso)

---

## 4. Detecci√≥n de Actividad Sospechosa

### 4.1 An√°lisis de Transacciones de Gemas

**Archivo**: [src/lib/rate-limit.ts](../src/lib/rate-limit.ts:131-189)

**Funci√≥n**:
```typescript
export async function detectSuspiciousActivity(
  userId: string,
  amount: number,
  source: string
): Promise<{ suspicious: boolean; reasons: string[] }>
```

**Reglas Implementadas**:

‚úÖ **Frecuencia de Transacciones**
```typescript
if (recentTransactions > 100) {
  reasons.push('Too many transactions in the last hour');
}
```

‚úÖ **Cantidades Anormales**
```typescript
if (amount > 10000) {
  reasons.push('Unusually large amount');
}
```

‚úÖ **Patrones de Farming**
```typescript
if (source === 'activity_completion' && recentAwards > 50) {
  reasons.push('Too many activity completions in short time');
}
```

**Per√≠odos Analizados**:
- √öltima hora: transacciones r√°pidas
- √öltimo d√≠a: volumen total

---

## 5. Validaci√≥n y Sanitizaci√≥n de Datos

### 5.1 Validaci√≥n de Inputs

**Archivo**: [src/lib/rate-limit.ts](../src/lib/rate-limit.ts:62-113)

**Funci√≥n**:
```typescript
export function validateGemsData(data: any): {
  valid: boolean;
  errors: string[]
}
```

**Validaciones Implementadas**:

‚úÖ **Amount**
- Requerido
- Tipo number positivo
- M√°ximo: 1,000,000 gemas
- Solo enteros

‚úÖ **Source**
- Requerido, string
- M√°ximo 100 caracteres

‚úÖ **Description**
- Requerido, string
- M√°ximo 500 caracteres

‚úÖ **Metadata (opcional)**
- Tipo objeto (no array)
- M√°ximo 2000 caracteres cuando serializado

### 5.2 Sanitizaci√≥n de Datos

**Funci√≥n**:
```typescript
export function sanitizeGemsData(data: any) {
  return {
    amount: Math.floor(Math.abs(data.amount || 0)),
    source: String(data.source || '').trim().slice(0, 100),
    sourceId: data.sourceId ? String(data.sourceId).trim().slice(0, 50) : undefined,
    description: String(data.description || '').trim().slice(0, 500),
    metadata: data.metadata && typeof data.metadata === 'object' ? data.metadata : {}
  };
}
```

**Protecciones**:
- Limpieza de espacios (trim)
- Truncado de longitud m√°xima
- Conversi√≥n de tipos forzada
- Valores por defecto seguros

---

## 6. Auditor√≠a y Logging

### 6.1 Modelo AuditLog

**Schema**:
```prisma
model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String
  changes     Json     // Cambios realizados
  metadata    Json?
  performedBy String?  // Usuario que realiz√≥ la acci√≥n
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  @@index([action])
  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([timestamp])
}
```

**Informaci√≥n Registrada**:
- ‚úÖ Qu√© acci√≥n se realiz√≥
- ‚úÖ Sobre qu√© entidad (tipo + ID)
- ‚úÖ Cambios exactos (JSON diff)
- ‚úÖ Qui√©n lo realiz√≥ (userId)
- ‚úÖ Desde d√≥nde (IP + User Agent)
- ‚úÖ Cu√°ndo (timestamp)

### 6.2 UserActivity

**Tracking de Actividad General**:
```prisma
model UserActivity {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([entityType, entityId])
}
```

### 6.3 FacebookEventLog

**Integraci√≥n con Facebook Pixel**:
```prisma
model FacebookEventLog {
  eventName        String    // Purchase, Lead, CompleteRegistration
  success          Boolean   // Si el env√≠o fue exitoso
  fbTraceId        String?   // ID de traza de Facebook
  errorMessage     String?   // Error si fall√≥

  @@index([eventName, createdAt])
  @@index([success, createdAt])
}
```

**Eventos Rastreados**:
- CompleteRegistration (registro de usuarios)
- Lead (login)
- Purchase (compras con crypto)

---

## 7. Seguridad en Pagos Crypto

### 7.1 Modelo CryptoConfig

**Configuraci√≥n Segura de Wallets**:
```prisma
model CryptoConfig {
  currency         String
  network          String
  chainId          Int
  walletAddress    String?    // Wallet de recepci√≥n
  contractAddress  String?    // Para tokens ERC20/BEP20
  minConfirmations Int @default(3)

  @@unique([currency, purpose, network])
}
```

**Seguridad**:
- ‚úÖ Configuraci√≥n centralizada
- ‚úÖ M√∫ltiples confirmaciones requeridas
- ‚úÖ Separaci√≥n por prop√≥sito (GAMEPASS_PAYMENT, REWARD_PAYMENT, GEM_EXCHANGE)
- ‚úÖ Validaci√≥n de red y chainId

### 7.2 Tracking de Transacciones

**GamePassPurchase / ProductPurchase**:
```prisma
status           CryptoPaymentStatus // PENDING, CONFIRMED, FAILED, EXPIRED, REFUNDED
transactionId    String @unique
txHash           String?
walletAddress    String // Wallet del comprador
cryptoAmount     Decimal @db.Decimal(18, 8) // Precisi√≥n decimal
```

**Seguridad**:
- ‚úÖ Estados bien definidos
- ‚úÖ IDs √∫nicos para prevenir duplicados
- ‚úÖ Registro de wallet address (anti-fraude)
- ‚úÖ Almacenamiento de txHash (verificaci√≥n blockchain)

---

## 8. Protecci√≥n de Endpoints API

### 8.1 Verificaci√≥n de Sesi√≥n

**Patr√≥n Com√∫n en API Routes**:
```typescript
const session = await getServerSession(authOptions);

if (!session?.user) {
  return NextResponse.json(
    { error: 'No autorizado' },
    { status: 401 }
  );
}
```

### 8.2 Verificaci√≥n de Roles

**Ejemplo de Control de Acceso**:
```typescript
if (session.user.role !== 'COMPANY_ADMIN' &&
    session.user.role !== 'SUPER_ADMIN') {
  return NextResponse.json(
    { error: 'Permisos insuficientes' },
    { status: 403 }
  );
}
```

### 8.3 Verificaci√≥n de Compa√±√≠a (Multi-tenant)

**Aislamiento de Datos**:
```typescript
const campaign = await prisma.campaign.findFirst({
  where: {
    id: params.id,
    companyId: session.user.companyId // CR√çTICO
  }
});
```

**Protecci√≥n**:
- ‚úÖ Previene acceso cross-company
- ‚úÖ Filtrado autom√°tico por companyId
- ‚úÖ Validaci√≥n en cada query

---

## 9. Protecciones Adicionales

### 9.1 CORS

**Configuraci√≥n en Next.js**:
- Controlado por framework (Next.js 15)
- Headers personalizados si es necesario
- Same-origin por defecto

### 9.2 Soft Deletes

**Campos deletedAt**:
```prisma
deletedAt DateTime?
```

**Beneficios**:
- ‚úÖ Recuperaci√≥n de datos accidental
- ‚úÖ Auditor√≠a completa
- ‚úÖ Cumplimiento normativo (GDPR)

### 9.3 Encriptaci√≥n de Tokens Sensibles

**UserGitHubAccount**:
```prisma
accessToken     String  // ‚ö†Ô∏è Deber√≠a estar encriptado
refreshToken    String?
```

**‚ö†Ô∏è Recomendaci√≥n**: Implementar encriptaci√≥n en BD para tokens OAuth

---

## 10. Vulnerabilidades y Recomendaciones

### 10.1 Identificadas (Bajo Riesgo)

‚ö†Ô∏è **Rate Limiting en Middleware Deshabilitado**
- **Causa**: Redis no funciona en Edge Runtime
- **Impacto**: Bajo (implementado en API routes individuales)
- **Acci√≥n**: Continuar migraci√≥n a API routes ‚úÖ

‚ö†Ô∏è **Tokens OAuth No Encriptados**
- **Causa**: Almacenamiento directo en BD
- **Impacto**: Medio (si hay acceso a BD)
- **Acci√≥n**: Implementar encriptaci√≥n AES-256 antes de almacenar

‚ö†Ô∏è **Logs Detallados en Producci√≥n**
- **Causa**: console.error con datos sensibles
- **Impacto**: Bajo (solo en logs server-side)
- **Acci√≥n**: Usar logger profesional (Winston/Pino) con niveles configurables

### 10.2 No Encontradas (‚úÖ Implementado Correctamente)

‚úÖ **SQL Injection**: Prisma ORM previene autom√°ticamente
‚úÖ **XSS**: React/Next.js escapan autom√°ticamente
‚úÖ **CSRF**: NextAuth.js incluye protecci√≥n CSRF
‚úÖ **Passwords en Texto Plano**: bcrypt implementado
‚úÖ **Session Hijacking**: JWT firmados con secret
‚úÖ **Inyecci√≥n NoSQL**: No aplica (PostgreSQL)

---

## 11. Medidas de Performance Relacionadas con Seguridad

### 11.1 √çndices Optimizados

**Para Consultas de Seguridad**:
```prisma
@@index([registrationIp])     // Buscar usuarios por IP
@@index([walletAddress])      // Detectar multicuentas
@@index([riskScore])          // Filtrar usuarios sospechosos
@@index([userId, status])     // Auditar transacciones
```

### 11.2 Redis Caching

**Uso**:
- Rate limiting distribuido
- Cach√© de configuraciones
- Session storage opcional

**Beneficios de Seguridad**:
- ‚úÖ Performance en validaciones repetitivas
- ‚úÖ Rate limiting efectivo en multi-worker
- ‚úÖ Reducci√≥n de carga en BD

---

## 12. Cumplimiento y Mejores Pr√°cticas

### 12.1 OWASP Top 10 (2021)

| Vulnerabilidad | Estado | Implementaci√≥n |
|----------------|--------|----------------|
| A01 - Broken Access Control | ‚úÖ Protegido | RBAC + Multi-tenant + Middleware |
| A02 - Cryptographic Failures | ‚ö†Ô∏è Parcial | bcrypt ‚úÖ / OAuth tokens ‚ö†Ô∏è |
| A03 - Injection | ‚úÖ Protegido | Prisma ORM |
| A04 - Insecure Design | ‚úÖ Protegido | Arquitectura segura |
| A05 - Security Misconfiguration | ‚úÖ Protegido | Env vars + Secrets |
| A06 - Vulnerable Components | ‚ö†Ô∏è Revisar | Dependencias actualizadas |
| A07 - Auth Failures | ‚úÖ Protegido | NextAuth + CAPTCHA + Email verification |
| A08 - Data Integrity Failures | ‚úÖ Protegido | JWT signed + AuditLog |
| A09 - Logging Failures | ‚úÖ Implementado | AuditLog + UserActivity + FacebookEventLog |
| A10 - SSRF | ‚úÖ Protegido | Validaci√≥n de URLs en endpoints |

### 12.2 GDPR / Privacidad

‚úÖ **Implementado**:
- Soft deletes (deletedAt)
- Anonimizaci√≥n posible (datos en JSON)
- Auditor√≠a completa de cambios
- Exportaci√≥n de datos de usuario

‚ö†Ô∏è **Pendiente**:
- Pol√≠tica de retenci√≥n autom√°tica
- Anonimizaci√≥n program√°tica

---

## 13. Monitoreo y Alertas

### 13.1 Logs Existentes

**Eventos Registrados**:
- ‚úÖ Intentos de login fallidos (auth.ts)
- ‚úÖ Verificaciones de CAPTCHA (captcha.ts)
- ‚úÖ Actividad sospechosa en gemas (rate-limit.ts)
- ‚úÖ Eventos de Facebook Pixel (FacebookEventLog)
- ‚úÖ Cambios cr√≠ticos (AuditLog)

### 13.2 Recomendaciones de Monitoreo

**M√©tricas a Rastrear**:
- Intentos de login fallidos por IP
- Usuarios con riskScore > 50
- Transacciones de gemas rechazadas
- Wallets compartidas detectadas
- Rate limits alcanzados

**Herramientas Sugeridas**:
- Sentry / DataDog para errores
- Grafana + Prometheus para m√©tricas
- ELK Stack para logs centralizados

---

## 14. Checklist de Seguridad

### Autenticaci√≥n ‚úÖ
- [x] Hashing de contrase√±as (bcrypt)
- [x] Verificaci√≥n de email obligatoria
- [x] CAPTCHA en registro/login
- [x] OAuth 2.0 (Google)
- [x] JWT con expiraci√≥n
- [x] Roles y permisos (RBAC)

### Anti-Bot ‚úÖ
- [x] hCaptcha implementado
- [x] IP tracking
- [x] Risk score por usuario
- [x] Wallet address tracking
- [x] Detecci√≥n de patrones sospechosos

### Rate Limiting ‚ö†Ô∏è
- [x] Implementado con Redis
- [x] Configurado en endpoints cr√≠ticos
- [ ] Habilitado en middleware global (limitaci√≥n t√©cnica)

### Validaci√≥n de Datos ‚úÖ
- [x] Validaci√≥n de inputs
- [x] Sanitizaci√≥n de strings
- [x] L√≠mites de tama√±o
- [x] Tipo checking

### Auditor√≠a ‚úÖ
- [x] AuditLog completo
- [x] UserActivity tracking
- [x] Logs de eventos externos (Facebook)
- [x] IP y User Agent en logs

### Infraestructura ‚úÖ
- [x] Variables de entorno (.env)
- [x] Secrets no commiteados
- [x] HTTPS forzado (producci√≥n)
- [x] CORS configurado

### Pendientes ‚ö†Ô∏è
- [ ] Encriptaci√≥n de OAuth tokens
- [ ] Logger profesional (Winston/Pino)
- [ ] Rotaci√≥n de secrets autom√°tica
- [ ] Rate limiting en middleware global (cuando Redis sea compatible con Edge)
- [ ] Alertas autom√°ticas de seguridad
- [ ] Pentesting profesional

---

## 15. Recomendaciones Finales

### Prioridad Alta üî¥
1. **Encriptar OAuth Tokens**: Implementar AES-256 para accessToken/refreshToken
2. **Logger Profesional**: Migrar de console.log a Winston/Pino con niveles
3. **Alertas de Seguridad**: Configurar notificaciones para eventos cr√≠ticos

### Prioridad Media üü°
4. **Pentesting Externo**: Contratar auditor√≠a de seguridad profesional
5. **WAF (Web Application Firewall)**: Cloudflare/AWS WAF para capa adicional
6. **Rotaci√≥n de Secrets**: Implementar rotaci√≥n autom√°tica de NEXTAUTH_SECRET

### Prioridad Baja üü¢
7. **2FA/MFA**: Autenticaci√≥n de dos factores opcional para usuarios
8. **Biometr√≠a**: Integraci√≥n con WebAuthn para dispositivos compatibles
9. **IP Whitelisting**: Para acciones administrativas cr√≠ticas

---

## Conclusi√≥n

La plataforma VW Activities cuenta con un **nivel de seguridad s√≥lido** en las √°reas cr√≠ticas:

‚úÖ **Fortalezas**:
- Autenticaci√≥n robusta con m√∫ltiples capas
- Sistema anti-bot efectivo con CAPTCHA y risk scoring
- Rate limiting implementado en endpoints cr√≠ticos
- Validaci√≥n y sanitizaci√≥n de datos
- Auditor√≠a completa con AuditLog
- Aislamiento multi-tenant correcto
- Protecci√≥n contra inyecciones SQL/XSS

‚ö†Ô∏è **√Åreas de Mejora**:
- Encriptaci√≥n de tokens OAuth sensibles
- Sistema de logging profesional
- Pentesting externo para validaci√≥n
- Alertas autom√°ticas de seguridad

**Recomendaci√≥n General**: La plataforma es segura para producci√≥n con las implementaciones actuales. Las mejoras sugeridas son optimizaciones que reducir√≠an a√∫n m√°s la superficie de ataque.

---

**Fecha del An√°lisis**: 2025-11-18
**Versi√≥n del Sistema**: Next.js 15.3.3 | Prisma 5.x | PostgreSQL
**Analizado por**: Claude Code (Anthropic)
